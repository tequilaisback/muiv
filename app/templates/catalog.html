{# app/templates/catalog.html #}
{% extends "base.html" %}

{% block title %}Каталог{% endblock %}

{% block content %}
  <div class="card section">
    <div class="row">
      <h1 style="margin:0;">Каталог</h1>

      <form class="right row" method="get" action="{{ url_for('main.catalog') }}">
        <select class="input" id="categorySelect" name="category_id" style="width:240px;">
          <option value="">Все категории</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if selected_category and selected_category.id == c.id %}selected{% endif %}>
              {{ c.name }}
            </option>
          {% endfor %}
        </select>

        <input class="input" style="width:260px;" name="q" value="{{ q or '' }}" placeholder="Поиск по названию">
        <button class="btn btn-small" type="submit">Найти</button>
        <a class="btn btn-small" href="{{ url_for('main.catalog') }}">Сброс</a>
      </form>
    </div>

    <p class="lead" style="margin-top:10px;">
      {% if selected_category %}
        Категория: <b>{{ selected_category.name }}</b>
      {% else %}
        Все товары
      {% endif %}
      {% if q %} · запрос: <b>{{ q }}</b>{% endif %}
    </p>
  </div>

  {% if products %}
    <div class="grid" style="margin-top:14px;">
      {% for p in products %}
        <a class="product-card" href="{{ url_for('main.product_detail', product_id=p.id) }}">
          <div class="product-thumb">
            {% if p.discount_percent and p.discount_percent > 0 %}
              <span class="badge badge-sale">-{{ p.discount_percent }}%</span>
            {% endif %}

            {% if p.image_filename %}
              <img
                src="{{ url_for('static', filename='img/products/' ~ p.image_filename) }}"
                alt="{{ p.name }}"
                style="width:100%;height:100%;object-fit:cover;display:block;"
              >
            {% else %}
              <div class="product-meta" style="padding:0 12px;text-align:center;">
                Нет изображения
              </div>
            {% endif %}
          </div>

          <div class="product-body">
            <p class="product-title">{{ p.name }}</p>
            <p class="product-meta">
              Категория: {{ p.category.name if p.category else "-" }}
            </p>

            <div class="price">
              {% if p.discount_percent and p.discount_percent > 0 %}
                <span class="price-now">{{ "%.2f"|format(p.final_price) }} ₽</span>
                <span class="price-old">{{ "%.2f"|format(p.price_value) }} ₽</span>
              {% else %}
                <span class="price-now">{{ "%.2f"|format(p.price_value) }} ₽</span>
              {% endif %}
            </div>

            <div class="row">
              <span class="btn btn-small">Открыть</span>
              {% if p.is_featured %}
                <span class="badge" style="position:static;">featured</span>
              {% endif %}
            </div>
          </div>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div class="card section">
      <p class="lead" style="margin:0;">Ничего не найдено. Попробуйте изменить фильтр или запрос.</p>
      <div class="row" style="margin-top:12px;">
        <a class="btn btn-primary" href="{{ url_for('main.catalog') }}">Показать всё</a>
        <a class="btn" href="{{ url_for('main.search') }}">Перейти к поиску</a>
      </div>
    </div>
  {% endif %}
{% endblock %}
