{# app/templates/catalog.html #}
{% extends "base.html" %}

{% block title %}Журнал измерений — {{ APP_TITLE }}{% endblock %}

{% block content %}
  <div class="row space-between">
    <div>
      <h1 class="card__title" style="margin:0;">Журнал измерений</h1>
      <p class="card__subtitle" style="margin:6px 0 0;">
        Фильтрация по спортсмену, показателю, команде и периоду. Можно включить отображение только отклонений.
      </p>
    </div>
    <div class="row">
      <a class="btn" href="{{ url_for('routes.offers') }}">Отклонения</a>
      {% if is_admin or is_coach or is_operator %}
        <a class="btn btn--primary" href="{{ url_for('admin.measurements') }}">Добавить (через админку)</a>
      {% endif %}
    </div>
  </div>

  <div class="card mt-16">
    <div class="card__body">
      <form class="filters" method="get" action="{{ url_for('routes.catalog') }}">
        <div class="field">
          <label>Спортсмен</label>
          <select name="athlete_id">
            <option value="">Все</option>
            {% for a in athletes %}
              <option value="{{ a.id }}" {% if filters.athlete_id==a.id %}selected{% endif %}>{{ a.full_name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label>Показатель</label>
          <select name="indicator_id">
            <option value="">Все</option>
            {% for i in indicators %}
              <option value="{{ i.id }}" {% if filters.indicator_id==i.id %}selected{% endif %}>{{ i.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field field--sm">
          <label>Команда</label>
          <select name="team_id">
            <option value="">Все</option>
            {% for t in teams %}
              <option value="{{ t.id }}" {% if filters.team_id==t.id %}selected{% endif %}>{{ t.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field field--sm">
          <label>С</label>
          <input class="input" name="from" value="{{ filters.from }}" placeholder="YYYY-MM-DD HH:MM">
        </div>

        <div class="field field--sm">
          <label>По</label>
          <input class="input" name="to" value="{{ filters.to }}" placeholder="YYYY-MM-DD HH:MM">
        </div>

        <div class="field field--sm">
          <label>Только отклонения</label>
          <select name="out">
            <option value="0" {% if filters.out=="0" %}selected{% endif %}>Нет</option>
            <option value="1" {% if filters.out=="1" %}selected{% endif %}>Да</option>
          </select>
        </div>

        <div class="field field--sm">
          <label>На страницу</label>
          <select name="per_page">
            {% for n in [10,20,50,100,200] %}
              <option value="{{ n }}" {% if filters.per_page==n %}selected{% endif %}>{{ n }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="actions">
          <button class="btn btn--primary" type="submit">Показать</button>
          <a class="btn" href="{{ url_for('routes.catalog') }}">Сбросить</a>
        </div>
      </form>
    </div>
  </div>

  {% if is_doctor %}
    <div class="card mt-16">
      <div class="card__body">
        <h2 class="card__title">Примечание врача</h2>
        <p class="card__subtitle">Выберите спортсмена в фильтрах и оставьте заметку по его состоянию.</p>

        {% if selected_athlete %}
          <div class="row mt-12" style="gap:10px;">
            <span class="badge">Спортсмен</span>
            <div><b>{{ selected_athlete.full_name }}</b></div>
          </div>

          <form class="form mt-12" method="post" action="{{ url_for('feedback.doctor_note_create') }}">
            <input type="hidden" name="athlete_id" value="{{ selected_athlete.id }}">
            <input type="hidden" name="next" value="{{ request.full_path }}">
            <div class="field">
              <label>Тема</label>
              <input class="input" name="title" required placeholder="Например: самочувствие после тренировки">
            </div>
            <div class="field">
              <label>Примечание</label>
              <textarea name="message" required placeholder="Кратко опишите состояние и рекомендации"></textarea>
            </div>
            <div class="row">
              <button class="btn btn--primary" type="submit">Сохранить примечание</button>
            </div>
          </form>
        {% else %}
          <p class="mt-12" style="margin:0; color: var(--muted);">
            Сначала выберите спортсмена в фильтрах журнала.
          </p>
        {% endif %}
      </div>
    </div>
  {% endif %}

  <div class="card mt-16">
    <div class="card__body">
      {% if pagination["items"] and pagination["items"]|length > 0 %}
        <table class="table">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Команда</th>
              <th>Спортсмен</th>
              <th>Показатель</th>
              <th>Значение</th>
              <th>Норма</th>
              <th>Статус</th>
            </tr>
          </thead>
          <tbody>
            {% for m in pagination["items"] %}
              {% set nmin = m.indicator.norm_min %}
              {% set nmax = m.indicator.norm_max %}
              {% set is_bad = ((nmin is not none and m.value < nmin) or (nmax is not none and m.value > nmax)) %}
              <tr>
                <td>{{ m.measured_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ m.athlete.team.name if m.athlete.team else "—" }}</td>
                <td>
                  <a href="{{ url_for('routes.product', athlete_id=m.athlete.id) }}"><b>{{ m.athlete.full_name }}</b></a>
                </td>
                <td>{{ m.indicator.name }}</td>
                <td><b>{{ m.value }}</b> {{ m.indicator.unit or "" }}</td>
                <td>
                  {% if nmin is not none or nmax is not none %}
                    {{ nmin if nmin is not none else "—" }} — {{ nmax if nmax is not none else "—" }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  {% if is_bad %}
                    <span class="badge badge--bad">Отклонение</span>
                  {% else %}
                    <span class="badge badge--ok">Норма</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="row mt-16 space-between">
          <div style="color: var(--muted); font-size: 13px;">
            Всего: {{ pagination.total }} • Стр: {{ pagination.page }}/{{ pagination.pages }}
          </div>

          <div class="row">
            {% if pagination.has_prev %}
              <a class="btn" href="{{ url_for('routes.catalog',
                    page=pagination.prev_page,
                    per_page=pagination.per_page,
                    athlete_id=filters.athlete_id,
                    indicator_id=filters.indicator_id,
                    team_id=filters.team_id,
                    from=filters.from,
                    to=filters.to,
                    out=filters.out
              ) }}">Назад</a>
            {% endif %}

            {% if pagination.has_next %}
              <a class="btn" href="{{ url_for('routes.catalog',
                    page=pagination.next_page,
                    per_page=pagination.per_page,
                    athlete_id=filters.athlete_id,
                    indicator_id=filters.indicator_id,
                    team_id=filters.team_id,
                    from=filters.from,
                    to=filters.to,
                    out=filters.out
              ) }}">Вперёд</a>
            {% endif %}
          </div>
        </div>
      {% else %}
        <p style="margin:0; color: var(--muted);">
          По заданным фильтрам данных нет. Попробуйте изменить условия.
        </p>
      {% endif %}
    </div>
  </div>
{% endblock %}
