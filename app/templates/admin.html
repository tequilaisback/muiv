{# app/templates/admin.html #}
{% extends "base.html" %}

{% block title %}Админ-панель{% endblock %}

{% block content %}
  <div class="card section">
    <div class="row">
      <h1 style="margin:0;">Админ-панель</h1>
      <div class="right row">
        <a class="btn btn-small" href="{{ url_for('admin.dashboard') }}">Обзор</a>
        {% if current_user and current_user.role == 'admin' %}
          <a class="btn btn-small" href="{{ url_for('admin.users_list') }}">Пользователи</a>
        {% endif %}
        <a class="btn btn-small" href="{{ url_for('admin.categories_list') }}">Категории</a>
        <a class="btn btn-small" href="{{ url_for('admin.products_list') }}">Товары</a>
        <a class="btn btn-small" href="{{ url_for('admin.feedback_list') }}">Обратная связь</a>
      </div>
    </div>

    <p class="lead" style="margin-top:10px;">
      Управление данными портала: пользователи, каталог и сообщения.
    </p>
  </div>

  {% if section == "dashboard" %}
    <div class="card section">
      <h2>Сводка</h2>

      <div class="grid" style="grid-template-columns: repeat(4, minmax(0, 1fr));">
        <div class="product-card">
          <div class="product-body">
            <div class="product-title">Пользователи</div>
            <div class="price"><span class="price-now">{{ stats.users }}</span></div>
            {% if current_user and current_user.role == 'admin' %}
              <a class="btn btn-small" href="{{ url_for('admin.users_list') }}">Открыть</a>
            {% endif %}
          </div>
        </div>

        <div class="product-card">
          <div class="product-body">
            <div class="product-title">Категории</div>
            <div class="price"><span class="price-now">{{ stats.categories }}</span></div>
            <a class="btn btn-small" href="{{ url_for('admin.categories_list') }}">Открыть</a>
          </div>
        </div>

        <div class="product-card">
          <div class="product-body">
            <div class="product-title">Товары</div>
            <div class="price"><span class="price-now">{{ stats.products }}</span></div>
            <a class="btn btn-small" href="{{ url_for('admin.products_list') }}">Открыть</a>
          </div>
        </div>

        <div class="product-card">
          <div class="product-body">
            <div class="product-title">Новые сообщения</div>
            <div class="price"><span class="price-now">{{ stats.feedback_new }}</span></div>
            <a class="btn btn-small" href="{{ url_for('admin.feedback_list', status='new') }}">Показать</a>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {% if section == "users" %}
    <div class="card section">
      <div class="row">
        <h2 style="margin:0;">Пользователи</h2>

        <form class="right row" method="get" action="{{ url_for('admin.users_list') }}">
          <input class="input" style="width:280px;" name="q" value="{{ q or '' }}" placeholder="Поиск: логин или ФИО">
          <button class="btn btn-small" type="submit">Найти</button>
          <a class="btn btn-small" href="{{ url_for('admin.users_list') }}">Сброс</a>
        </form>
      </div>

      <hr class="sep">

      <h3>Создать пользователя</h3>
      <form method="post" action="{{ url_for('admin.users_create') }}" class="form-grid">
        <div>
          <label>Логин</label>
          <input class="input" name="login" required>
        </div>
        <div>
          <label>Пароль</label>
          <input class="input" name="password" type="password" required>
        </div>
        <div>
          <label>ФИО</label>
          <input class="input" name="full_name" required>
        </div>
        <div>
          <label>Роль</label>
          <select class="input" name="role">
            {% for r in roles %}
              <option value="{{ r }}">{{ r }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="row" style="grid-column:1/-1;">
          <button class="btn btn-primary" type="submit">Создать</button>
        </div>
      </form>

      <hr class="sep">

      <h3>Список</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Логин</th>
              <th>ФИО</th>
              <th>Роль</th>
              <th>Активен</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
              <tr>
                <td>{{ u.id }}</td>
                <td>{{ u.login }}</td>
                <td>{{ u.full_name }}</td>
                <td>{{ u.role }}</td>
                <td>{{ 'да' if u.is_active else 'нет' }}</td>
                <td>
                  <div class="actions">
                    <details>
                      <summary class="btn btn-small">Изменить</summary>
                      <div style="margin-top:10px;">
                        <form method="post" action="{{ url_for('admin.users_update', user_id=u.id) }}" class="form-grid-1">
                          <div>
                            <label>ФИО</label>
                            <input class="input" name="full_name" value="{{ u.full_name }}">
                          </div>
                          <div>
                            <label>Роль</label>
                            <select class="input" name="role">
                              {% for r in roles %}
                                <option value="{{ r }}" {% if u.role == r %}selected{% endif %}>{{ r }}</option>
                              {% endfor %}
                            </select>
                          </div>
                          <div class="row">
                            <label style="display:flex;align-items:center;gap:8px;">
                              <input type="checkbox" name="is_active" {% if u.is_active %}checked{% endif %}>
                              Активен
                            </label>
                          </div>
                          <div>
                            <label>Новый пароль (если нужно)</label>
                            <input class="input" name="new_password" type="password" placeholder="оставьте пустым, чтобы не менять">
                          </div>
                          <div class="row">
                            <button class="btn btn-success btn-small" type="submit">Сохранить</button>
                          </div>
                        </form>
                      </div>
                    </details>

                    <form method="post" action="{{ url_for('admin.users_delete', user_id=u.id) }}">
                      <button class="btn btn-danger btn-small" type="submit" data-confirm="Удалить пользователя {{ u.login }}?">Удалить</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {% if section == "categories" %}
    <div class="card section">
      <div class="row">
        <h2 style="margin:0;">Категории</h2>
      </div>

      <hr class="sep">

      <h3>Создать категорию</h3>
      <form method="post"
            action="{{ url_for('admin.categories_create') }}"
            class="form-grid"
            enctype="multipart/form-data">
        <div>
          <label>Название</label>
          <input class="input" name="name" required>
        </div>
        <div>
          <label>Описание (опционально)</label>
          <input class="input" name="description">
        </div>

        <div style="grid-column:1/-1;">
          <label>Фото категории (опционально)</label>
          <input class="input" type="file" name="image" accept=".png,.jpg,.jpeg,.webp,.gif,image/*">
          <div class="product-meta" style="margin-top:6px;">
            Без БД: файл сохранится в <b>app/static/img/categories/</b> с именем вида <b>cat_ID.jpg</b>.
          </div>
        </div>

        <div class="row" style="grid-column:1/-1;">
          <button class="btn btn-primary" type="submit">Создать</button>
        </div>
      </form>

      <hr class="sep">

      <h3>Список</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Фото</th>
              <th>Название</th>
              <th>Активна</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for c in categories %}
              {% set cat_img = (category_images.get(c.id) if category_images is defined else None) %}
              <tr>
                <td>{{ c.id }}</td>

                <td style="width:90px;">
                  {% if cat_img %}
                    <img
                      src="{{ url_for('static', filename='img/categories/' ~ cat_img) }}"
                      alt="Фото категории"
                      style="width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.10);"
                    >
                  {% else %}
                    <span class="product-meta">—</span>
                  {% endif %}
                </td>

                <td>{{ c.name }}</td>
                <td>{{ 'да' if c.is_active else 'нет' }}</td>
                <td>
                  <div class="actions">
                    <details>
                      <summary class="btn btn-small">Изменить</summary>
                      <div style="margin-top:10px;">
                        <form method="post"
                              action="{{ url_for('admin.categories_update', category_id=c.id) }}"
                              class="form-grid-1"
                              enctype="multipart/form-data">
                          <div>
                            <label>Название</label>
                            <input class="input" name="name" value="{{ c.name }}">
                          </div>
                          <div>
                            <label>Описание</label>
                            <input class="input" name="description" value="{{ c.description or '' }}">
                          </div>

                          <div>
                            <label>Фото категории (выберите, чтобы заменить)</label>
                            <input class="input" type="file" name="image" accept=".png,.jpg,.jpeg,.webp,.gif,image/*">
                            {% if cat_img %}
                              <div class="row" style="margin-top:10px;">
                                <img
                                  src="{{ url_for('static', filename='img/categories/' ~ cat_img) }}"
                                  alt="Текущее фото"
                                  style="width:92px;height:92px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.10);"
                                >
                                <div class="product-meta">
                                  Текущее: <b>{{ cat_img }}</b><br>
                                  Если выбрать новый файл — старый будет заменён.
                                </div>
                              </div>
                            {% else %}
                              <div class="product-meta" style="margin-top:6px;">Фото ещё не задано.</div>
                            {% endif %}
                          </div>

                          <div class="row">
                            <label style="display:flex;align-items:center;gap:8px;">
                              <input type="checkbox" name="is_active" {% if c.is_active %}checked{% endif %}>
                              Активна
                            </label>
                          </div>

                          <div class="row">
                            <button class="btn btn-success btn-small" type="submit">Сохранить</button>
                          </div>
                        </form>
                      </div>
                    </details>

                    <form method="post" action="{{ url_for('admin.categories_delete', category_id=c.id) }}">
                      <button class="btn btn-danger btn-small" type="submit" data-confirm="Удалить категорию {{ c.name }}?">Удалить</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {% if section == "products" %}
    <div class="card section">
      <div class="row">
        <h2 style="margin:0;">Товары</h2>

        <form class="right row" method="get" action="{{ url_for('admin.products_list') }}">
          <input class="input" style="width:280px;" name="q" value="{{ q or '' }}" placeholder="Поиск по названию">
          <button class="btn btn-small" type="submit">Найти</button>
          <a class="btn btn-small" href="{{ url_for('admin.products_list') }}">Сброс</a>
        </form>
      </div>

      <hr class="sep">

      <h3>Создать товар</h3>
      <form method="post"
            action="{{ url_for('admin.products_create') }}"
            class="form-grid"
            enctype="multipart/form-data">
        <div>
          <label>Категория</label>
          <select class="input" name="category_id" required>
            {% for c in categories %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>Название</label>
          <input class="input" name="name" required>
        </div>

        <div>
          <label>Цена</label>
          <input class="input" name="price" placeholder="например: 1990.00">
        </div>

        <div>
          <label>Скидка %</label>
          <input class="input" name="discount_percent" value="0">
        </div>

        <div style="grid-column:1/-1;">
          <label>Описание</label>
          <input class="input" name="description">
        </div>

        <div style="grid-column:1/-1;">
          <label>Фото товара (опционально)</label>
          <input class="input" type="file" name="image" accept=".png,.jpg,.jpeg,.webp,.gif,image/*">
          <div class="product-meta" style="margin-top:6px;">
            Файл будет скопирован в <b>app/static/img/products/</b> и сохранён в поле <b>image_filename</b>.
          </div>
        </div>

        <div class="row" style="grid-column:1/-1;">
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" name="is_featured">
            Показать на главной (featured)
          </label>
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" name="is_active" checked>
            Активен
          </label>
        </div>

        <div class="row" style="grid-column:1/-1;">
          <button class="btn btn-primary" type="submit">Создать</button>
        </div>
      </form>

      <hr class="sep">

      <h3>Список</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Фото</th>
              <th>Название</th>
              <th>Категория</th>
              <th>Цена</th>
              <th>Скидка</th>
              <th>Активен</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for p in products %}
              <tr>
                <td>{{ p.id }}</td>

                <td style="width:90px;">
                  {% if p.image_filename %}
                    <img
                      src="{{ url_for('static', filename='img/products/' ~ p.image_filename) }}"
                      alt="Фото товара"
                      style="width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.10);"
                    >
                  {% else %}
                    <span class="product-meta">—</span>
                  {% endif %}
                </td>

                <td>{{ p.name }}</td>
                <td>{{ p.category.name if p.category else '-' }}</td>
                <td>{{ "%.2f"|format(p.price_value) }}</td>
                <td>{{ p.discount_percent }}%</td>
                <td>{{ 'да' if p.is_active else 'нет' }}</td>
                <td>
                  <div class="actions">
                    <details>
                      <summary class="btn btn-small">Изменить</summary>
                      <div style="margin-top:10px;">
                        <form method="post"
                              action="{{ url_for('admin.products_update', product_id=p.id) }}"
                              class="form-grid"
                              enctype="multipart/form-data">
                          <div>
                            <label>Категория</label>
                            <select class="input" name="category_id">
                              {% for c in categories %}
                                <option value="{{ c.id }}" {% if p.category_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                              {% endfor %}
                            </select>
                          </div>

                          <div>
                            <label>Название</label>
                            <input class="input" name="name" value="{{ p.name }}">
                          </div>

                          <div>
                            <label>Цена</label>
                            <input class="input" name="price" value="{{ "%.2f"|format(p.price_value) }}">
                          </div>

                          <div>
                            <label>Скидка %</label>
                            <input class="input" name="discount_percent" value="{{ p.discount_percent }}">
                          </div>

                          <div style="grid-column:1/-1;">
                            <label>Описание</label>
                            <input class="input" name="description" value="{{ p.description or '' }}">
                          </div>

                          <div style="grid-column:1/-1;">
                            <label>Фото товара (выберите, чтобы заменить)</label>
                            <input class="input" type="file" name="image" accept=".png,.jpg,.jpeg,.webp,.gif,image/*">
                            {% if p.image_filename %}
                              <div class="row" style="margin-top:10px;">
                                <img
                                  src="{{ url_for('static', filename='img/products/' ~ p.image_filename) }}"
                                  alt="Текущее фото"
                                  style="width:92px;height:92px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.10);"
                                >
                                <div class="product-meta">
                                  Текущее: <b>{{ p.image_filename }}</b><br>
                                  Если выбрать новый файл — старый будет удалён.
                                </div>
                              </div>
                            {% else %}
                              <div class="product-meta" style="margin-top:6px;">Фото ещё не задано.</div>
                            {% endif %}
                          </div>

                          <div class="row" style="grid-column:1/-1;">
                            <label style="display:flex;align-items:center;gap:8px;">
                              <input type="checkbox" name="is_featured" {% if p.is_featured %}checked{% endif %}>
                              Featured
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;">
                              <input type="checkbox" name="is_active" {% if p.is_active %}checked{% endif %}>
                              Активен
                            </label>
                          </div>

                          <div class="row" style="grid-column:1/-1;">
                            <button class="btn btn-success btn-small" type="submit">Сохранить</button>
                          </div>
                        </form>
                      </div>
                    </details>

                    <form method="post" action="{{ url_for('admin.products_delete', product_id=p.id) }}">
                      <button class="btn btn-danger btn-small" type="submit" data-confirm="Удалить товар {{ p.name }}?">Удалить</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {% if section == "feedback" %}
    <div class="card section">
      <div class="row">
        <h2 style="margin:0;">Обратная связь</h2>

        <div class="right row">
          <a class="btn btn-small" href="{{ url_for('admin.feedback_list') }}">Все</a>
          <a class="btn btn-small" href="{{ url_for('admin.feedback_list', status='new') }}">Новые</a>
          <a class="btn btn-small" href="{{ url_for('admin.feedback_list', status='processed') }}">Обработанные</a>
        </div>
      </div>

      <p class="lead" style="margin-top:10px;">
        Фильтр: <b>{{ status if status else "все" }}</b>
      </p>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Дата</th>
              <th>От</th>
              <th>Тема</th>
              <th>Сообщение</th>
              <th>Статус</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for f in feedback_items %}
              <tr>
                <td>{{ f.id }}</td>
                <td>{{ f.created_at.strftime("%Y-%m-%d %H:%M") if f.created_at else "" }}</td>
                <td>
                  <div><b>{{ f.name }}</b></div>
                  <div class="product-meta">{{ f.email }}</div>
                </td>
                <td>{{ f.subject }}</td>
                <td style="max-width:420px;">
                  <div style="white-space:pre-wrap;">{{ f.message }}</div>
                </td>
                <td>{{ f.status }}</td>
                <td>
                  <div class="actions">
                    <form method="post" action="{{ url_for('admin.feedback_set_status', feedback_id=f.id) }}">
                      <input type="hidden" name="status" value="{{ 'processed' if f.status == 'new' else 'new' }}">
                      <button class="btn btn-small" type="submit">
                        {% if f.status == 'new' %}В обработано{% else %}В новое{% endif %}
                      </button>
                    </form>

                    <form method="post" action="{{ url_for('admin.feedback_delete', feedback_id=f.id) }}">
                      <button class="btn btn-danger btn-small" type="submit" data-confirm="Удалить сообщение #{{ f.id }}?">Удалить</button>
                    </form>
                  </div>
                </td>
              </tr>
              
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  {% endif %}

{% endblock %}
