{# app/templates/offers.html #}
{% extends "base.html" %}

{% block title %}Отклонения от нормы — {{ APP_TITLE }}{% endblock %}

{% block content %}
  <div class="row space-between">
    <div>
      <h1 class="card__title" style="margin:0;">Отклонения от нормы</h1>
      <p class="card__subtitle" style="margin:6px 0 0;">
        Список измерений, которые выходят за пределы нормы (min/max) по выбранному показателю.
      </p>
    </div>
    <div class="row">
      <a class="btn" href="{{ url_for('routes.catalog') }}">Журнал</a>
      <a class="btn btn--primary" href="{{ url_for('routes.search') }}">Поиск</a>
    </div>
  </div>

  <div class="card mt-16">
    <div class="card__body">
      <form class="filters" method="get" action="{{ url_for('routes.offers') }}">
        <div class="field">
          <label>Спортсмен</label>
          <select name="athlete_id">
            <option value="">Все</option>
            {% for a in athletes %}
              <option value="{{ a.id }}" {% if filters.athlete_id==a.id %}selected{% endif %}>{{ a.full_name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label>Показатель</label>
          <select name="indicator_id">
            <option value="">Все</option>
            {% for i in indicators %}
              <option value="{{ i.id }}" {% if filters.indicator_id==i.id %}selected{% endif %}>{{ i.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field field--sm">
          <label>Команда</label>
          <select name="team_id">
            <option value="">Все</option>
            {% for t in teams %}
              <option value="{{ t.id }}" {% if filters.team_id==t.id %}selected{% endif %}>{{ t.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field field--sm">
          <label>С</label>
          <input class="input" name="from" value="{{ filters.from }}" placeholder="YYYY-MM-DD HH:MM">
        </div>

        <div class="field field--sm">
          <label>По</label>
          <input class="input" name="to" value="{{ filters.to }}" placeholder="YYYY-MM-DD HH:MM">
        </div>

        <div class="field field--sm">
          <label>На страницу</label>
          <select name="per_page">
            {% for n in [10,20,50,100,200] %}
              <option value="{{ n }}" {% if filters.per_page==n %}selected{% endif %}>{{ n }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="actions">
          <button class="btn btn--primary" type="submit">Показать</button>
          <a class="btn" href="{{ url_for('routes.offers') }}">Сбросить</a>
        </div>
      </form>
    </div>
  </div>

  <div class="card mt-16">
    <div class="card__body">
      {% if pagination["items"] and pagination["items"]|length > 0 %}
        <table class="table">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Команда</th>
              <th>Спортсмен</th>
              <th>Показатель</th>
              <th>Значение</th>
              <th>Норма</th>
              <th>Причина</th>
              <th>Статус</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for a in pagination["items"] %}
              {% set m = a.measurement %}
              {% set ind = m.indicator if m else None %}
              {% set nmin = ind.norm_min if ind else none %}
              {% set nmax = ind.norm_max if ind else none %}
              <tr>
                <td>{{ m.measured_at.strftime('%Y-%m-%d %H:%M') if m and m.measured_at else "—" }}</td>
                <td>{{ m.athlete.team.name if m and m.athlete and m.athlete.team else "—" }}</td>
                <td>
                  {% if m and m.athlete %}
                    <a href="{{ url_for('routes.product', athlete_id=m.athlete.id) }}"><b>{{ m.athlete.full_name }}</b></a>
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>{{ ind.name if ind else "—" }}</td>
                <td>
                  {% if m %}
                    <b>{{ m.value }}</b> {{ ind.unit if ind and ind.unit else "" }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  {% if nmin is not none or nmax is not none %}
                    {{ nmin if nmin is not none else "—" }} — {{ nmax if nmax is not none else "—" }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  {% if a.level == 'low' %}
                    <span class="badge badge--bad">Ниже нормы</span>
                  {% elif a.level == 'high' %}
                    <span class="badge badge--bad">Выше нормы</span>
                  {% else %}
                    <span class="badge badge--warn">Вне диапазона</span>
                  {% endif %}
                </td>
                <td>
                  {% if a.status == 'closed' %}
                    <span class="badge badge--ok">Закрыто</span>
                  {% else %}
                    <span class="badge badge--warn">Открыто</span>
                  {% endif %}
                </td>
                <td style="text-align:right;">
                  {% if (is_admin or is_doctor) and a.status != 'closed' %}
                    <form method="post" action="{{ url_for('admin.alerts_close', alert_id=a.id) }}" style="display:inline;">
                      <button class="btn btn--danger" type="submit">Закрыть</button>
                    </form>
                  {% else %}
                    <span class="badge">—</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="row mt-16 space-between">
          <div style="color: var(--muted); font-size: 13px;">
            Всего: {{ pagination.total }} • Стр: {{ pagination.page }}/{{ pagination.pages }}
          </div>

          <div class="row">
            {% if pagination.has_prev %}
              <a class="btn" href="{{ url_for('routes.offers',
                    page=pagination.prev_page,
                    per_page=pagination.per_page,
                    athlete_id=filters.athlete_id,
                    indicator_id=filters.indicator_id,
                    team_id=filters.team_id,
                    from=filters.from,
                    to=filters.to
              ) }}">Назад</a>
            {% endif %}

            {% if pagination.has_next %}
              <a class="btn" href="{{ url_for('routes.offers',
                    page=pagination.next_page,
                    per_page=pagination.per_page,
                    athlete_id=filters.athlete_id,
                    indicator_id=filters.indicator_id,
                    team_id=filters.team_id,
                    from=filters.from,
                    to=filters.to
              ) }}">Вперёд</a>
            {% endif %}
          </div>
        </div>
      {% else %}
        <p style="margin:0; color: var(--muted);">
          Отклонений не найдено по выбранным параметрам.
        </p>
      {% endif %}
    </div>
  </div>

{% endblock %}
